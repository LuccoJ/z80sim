#include "screen.h"

#include "strings.h"
#include "scheduling.h"
#include "exceptions.h"

#include "simulator.h"

const char CharacterSet[256][8]={
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // space
	{0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x08, 0x00}, // !
	{0x14, 0x14, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
	{0x24, 0x7E, 0x24, 0x24, 0x24, 0x7E, 0x24, 0x00}, // #
	{0x08, 0x3C, 0x48, 0x3C, 0x0A, 0x2A, 0x1C, 0x08}, // $
	{0x22, 0x74, 0x28, 0x18, 0x14, 0x2E, 0x44, 0x00}, // %
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
	{0x08, 0x10, 0x10, 0x10, 0x10, 0x10, 0x08, 0x00}, // (
	{0x10, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x00}, // )
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}, // .
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
	{0x3C, 0x46, 0x4A, 0x5A, 0x52, 0x62, 0x3C, 0x00}, // 0
	{0x08, 0x18, 0x28, 0x08, 0x08, 0x08, 0x08, 0x00}, // 1
	{0x3C, 0x42, 0x02, 0x04, 0x18, 0x20, 0x7E, 0x00}, // 2
	{0x7C, 0x02, 0x02, 0x3C, 0x02, 0x02, 0x7C, 0x00}, // 3
	{0x04, 0x0C, 0x14, 0x24, 0x44, 0x7E, 0x04, 0x00}, // 4
	{0x7E, 0x40, 0x40, 0x7C, 0x02, 0x02, 0x7C, 0x00}, // 5
	{0x3C, 0x42, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00}, // 6
	{0x7E, 0x02, 0x02, 0x04, 0x04, 0x08, 0x08, 0x00}, // 7
	{0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00}, // 8
	{0x3C, 0x42, 0x42, 0x3E, 0x02, 0x42, 0x3C, 0x00}, // 9
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x3C, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00}, // A
        {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00}, // B
        {0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00}, // C
        {0x7C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x7C, 0x00}, // D
        {0x7E, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7E, 0x00}, // E
        {0x7E, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00}, // F
        {0x3E, 0x40, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00}, // G
        {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00}, // H
        {0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00}, // I
        {0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x30, 0x00}, // J
        {0x42, 0x44, 0x48, 0x7C, 0x42, 0x42, 0x42, 0x00}, // K
        {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00}, // L
        {0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00}, // M
        {0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x00}, // N
        {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}, // O
        {0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x00}, // P
        {0x3C, 0x42, 0x42, 0x42, 0x42, 0x46, 0x3E, 0x00}, // Q
        {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x42, 0x00}, // R
        {0x3E, 0x40, 0x40, 0x3C, 0x02, 0x02, 0x7C, 0x00}, // S
        {0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00}, // T
        {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}, // U
        {0x44, 0x44, 0x44, 0x44, 0x44, 0x28, 0x10, 0x00}, // V
        {0x42, 0x42, 0x42, 0x42, 0x5A, 0x66, 0x42, 0x00}, // W
        {0x42, 0x42, 0x24, 0x18, 0x24, 0x42, 0x42, 0x00}, // X
        {0x42, 0x42, 0x3E, 0x02, 0x02, 0x42, 0x3C, 0x00}, // Y
        {0x7E, 0x02, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x00}, // Z
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // empty
        {0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00}  // long dash

};

void ScreenClear(color Paper, color Ink) {
        int i;
	_SimUnprotect(0x4000, 0x5fff);
        for(i=0; i<0x1800; i++) {
                ScreenMemory[i]=0;
        }
        for(i=0; i<0x0300; i++) {
                AttribMemory[i]=Paper<<3|Ink;
        }
	_SimPrintString("Screen cleared\n");
	_SimRWProtect(0x4000, 0x5fff);
}

void SetAttrib(char Attrib, short Row, short Column) {
        _SimUnprotect(0x4000, 0x5fff);
        AttribMemory[Column+(Row<<5)]=Attrib;
	_SimRWProtect(0x4000, 0x5fff);
}

void PutCharacter(char AsciiCode, short Row, short Column) {
        short i;
	unsigned int SectionStart, CharStart;
	short SectionOffset;
	_SimUnprotect(0x4000, 0x5fff);
	SectionStart=0; SectionOffset=Row;
	while(SectionOffset>=8) {
		SectionOffset-=8;
		SectionStart+=2048;
	}
	CharStart=SectionStart+Column+((int)SectionOffset<<5);
	for(i=0; i<8; i++) {
                ScreenMemory[CharStart+((int)i<<8)]=CharacterSet[AsciiCode-' '][i];
        }
	_SimRWProtect(0x4000, 0x5fff);
}

void PutString(char* String, short Row, short Column) {
        short i;
	short Length;
	Length=StringLength(String);
        for(i=0; i<Length; i++) {
                PutCharacter(String[i], Row, Column+i);
        }
	_SimPrintString("String: ");
	_SimPrintString(String);
	_SimPrintCharacter('\n');
}
